{% extends "base.html" %}
{% block title %}{{ problem.title }} | PeerHelp{% endblock %}
{% block body_class %}problem-detail-page{% endblock %}
{% block content %}
<a
  class="btn btn-orange-link mb-4 d-inline-flex align-items-center gap-2"
  href="{% url 'browse-problems' %}"
>
  <i data-lucide="arrow-left"></i>
  Back to Problems
</a>

<section class="mentora-card problem-hero-card mb-4">
  <div class="card-body p-4 p-lg-5">
    <div class="row g-4 align-items-start">
      <div class="col-md-auto text-center text-md-start">
        {% include "components/avatar.html" with src=problem.author.avatar initials=problem.author.initials|default:problem.author.name|first extra_classes="hero-avatar" %}
        <div class="mt-3 text-gray-900 fw-semibold">
          {{ problem.author.name }}{% if problem.author.is_verified %} <i data-lucide="badge-check" class="text-emerald-600" title="Verified User"></i>{% endif %}
        </div>
        <div
          class="small text-muted-soft d-flex align-items-center justify-content-center justify-content-md-start gap-1"
        >
          <i
            data-lucide="award"
            class="text-amber-600"
            style="width: 14px; height: 14px"
          ></i>
          {{ problem.author.credits }} credits
        </div>
        <div class="small text-muted-soft">
          {{ problem.author.solved }} problems solved
        </div>
        <div class="small text-muted-soft">
          ⭐ {{ problem.author.rating }} rating
        </div>
      </div>
      <div class="col">
        <div class="d-flex flex-column flex-lg-row gap-4 align-items-lg-start">
          <div class="flex-grow-1">
            <div class="d-flex flex-wrap align-items-start gap-3 mb-3">
              <div class="flex-grow-1">
                <h1 class="h3 text-gray-900 mb-2">{{ problem.title }}</h1>
                <div
                  class="problem-meta text-muted-soft small d-flex flex-wrap align-items-center gap-3"
                >
                  <span
                    class="d-inline-flex align-items-center gap-2 text-capitalize"
                  >
                    {% if problem.mode == 'in_person' %}
                    <i data-lucide="map-pin"></i>
                    {% else %}
                    <i data-lucide="monitor"></i>
                    {% endif %} {{ problem.mode_label }}
                  </span>
                  <span class="d-inline-flex align-items-center gap-2">
                    <i data-lucide="clock"></i>
                    {{ problem.time }}
                  </span>
                  <span class="d-inline-flex align-items-center gap-2">
                    <i data-lucide="message-circle"></i>
                    {{ problem.responses }} responses
                  </span>
                </div>
              </div>
              <span
                class="badge-soft urgency-badge urgency-{{ problem.urgency }}"
                >{{ problem.urgency }}</span
              >
            </div>
            <div class="d-flex flex-wrap gap-2 mb-3">
              {% for tag in problem.tags %}
              <span class="tag-pill">{{ tag }}</span>
              {% endfor %}
            </div>
            <div class="credit-pill">
              <i data-lucide="award"></i>
              {{ problem.credits }} credits offered
            </div>
          </div>
          {% if is_owner %}
          <div class="owner-action-stack w-100 w-lg-auto ms-lg-auto">
            <div class="text-muted-soft small text-uppercase fw-semibold mb-2">
              Manage Problem
            </div>
            <div class="d-flex flex-wrap flex-lg-column gap-2">
              <a
                class="btn btn-orange-outline d-inline-flex align-items-center gap-2 justify-content-center"
                href="{{ problem_edit_url }}"
              >
                <i data-lucide="pencil"></i>
                Update
              </a>
              <form
                method="post"
                action="{{ problem_delete_url }}"
                data-confirm="Delete this problem permanently?"
              >
                {% csrf_token %}
                <button
                  class="btn btn-orange d-inline-flex align-items-center gap-2 justify-content-center w-100"
                  type="submit"
                >
                  <i data-lucide="trash-2"></i>
                  Delete
                </button>
              </form>
            </div>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</section>

<section class="mentora-card mb-4 problem-description-card">
  <div class="card-header bg-transparent border-0 pb-0 px-4 pt-4">
    <h2 class="h5 text-gray-900 mb-0">Problem Description</h2>
  </div>
  <div class="card-body p-4">
    <p class="text-muted-soft whitespace-pre-line">{{ problem.description }}</p>
  </div>
</section>

{% if problem.attachments %}
<section class="mentora-card mb-4">
  <div class="card-header bg-transparent border-0 pb-0">
    <h2 class="h5 text-gray-900 mb-0">Attachments</h2>
  </div>
  <div class="card-body">
    <div class="attachment-grid">
      {% for attachment in problem.attachments %}
      <div class="attachment-tile">
        <div class="attachment-icon">
          <i data-lucide="file-text"></i>
        </div>
        <div class="flex-grow-1">
          <div class="fw-semibold text-gray-900 text-truncate">
            {{ attachment.name }}
          </div>
          <div class="text-uppercase small text-muted-soft">
            {{ attachment.type }}
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
</section>
{% endif %} {% if is_owner %}
<section class="mentora-card mb-4 owner-review-card">
  <div
    class="card-header bg-transparent border-0 pb-0 px-4 pt-4 d-flex justify-content-between align-items-center"
  >
    <h2 class="h5 text-gray-900 mb-0">Owner Review Panel</h2>
    {% if owner_solver_details %}
    <span class="badge-soft teal">{{ problem.status_label }}</span>
    {% endif %}
  </div>
  <div class="card-body p-4">
    {% if owner_solver_details %}
    <div class="d-flex align-items-center gap-3 mb-3">
      {% include "components/avatar.html" with src=owner_solver_details.avatar initials=owner_solver_details.initials extra_classes="solver-avatar" %}
      <div>
        <p class="text-muted-soft small mb-1">Accepted by</p>
        <div class="h6 text-gray-900 mb-0">{{ owner_solver_details.name }}</div>
        <div class="small text-muted-soft d-flex gap-3 flex-wrap">
          <span class="d-inline-flex align-items-center gap-1">
            <i data-lucide="award"></i>
            {{ owner_solver_details.credits }} credits
          </span>
          <span>⭐ {{ owner_solver_details.rating }}</span>
        </div>
      </div>
    </div>
    {% else %}
    <p class="text-muted-soft">
      No solver has formally accepted this problem yet, but you can still review
      incoming solutions below.
    </p>
    {% endif %} {% if owner_solver_solution %}
    <div class="owner-solution-preview mb-3">
      <div class="fw-semibold text-gray-900 mb-2">Submitted Solution</div>
      <div class="text-muted-soft whitespace-pre-line">
        {{ owner_solver_solution.content }}
      </div>
    </div>
    {% if owner_solver_solution.is_accepted %}
    <div class="alert alert-success d-flex flex-column gap-2">
      <div class="d-flex align-items-center gap-2">
        <i data-lucide="check-circle"></i>
        Solution accepted and marked as solved.
      </div>
      {% if owner_solver_review %}
      <div>
        <div class="small text-muted-soft">Your review</div>
        <div class="fw-semibold text-gray-900">
          Rating: {{ owner_solver_review.rating }} ★
        </div>
        <p class="mb-0 text-muted-soft">{{ owner_solver_review.comment }}</p>
      </div>
      {% endif %}
    </div>
    {% elif owner_review_form %}
    <div class="border rounded-3 p-3">
      <h3 class="h6 text-gray-900 mb-3">Accept &amp; Review Solution</h3>
      <form
        method="post"
        action="{% url 'solution-accept' owner_solver_solution.id %}"
      >
        {% csrf_token %}
        <div class="mb-3">
          <label class="form-label">Rating</label>
          {{ owner_review_form.rating }}
          <div class="rating-stars-input" data-rating-control>
            {% for _ in '12345'|make_list %}
            <button
              type="button"
              class="rating-star"
              data-rating-star="{{ forloop.counter }}"
            >
              <i data-lucide="star"></i>
            </button>
            {% endfor %}
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label">Review</label>
          {{ owner_review_form.comment }}
        </div>
        <button class="btn btn-orange" type="submit">Accept Solution</button>
      </form>
    </div>
    {% elif owner_solution_matches_solver %}
    <div class="alert alert-info">Awaiting your decision on this solution.</div>
    {% else %}
    <div class="alert alert-warning">
      {{ owner_solution_author_name }} submitted this solution but has not
      currently locked the problem. Ask them to accept the problem before you
      can mark it solved.
    </div>
    {% endif %} {% else %}
    <p class="text-muted-soft mb-0">
      No solutions have been submitted yet. Once they do, they will appear here.
    </p>
    {% endif %}
  </div>
</section>
{% endif %}

<section class="cta-card mb-5 text-center text-white">
  <div class="card-body p-4 p-lg-5">
    <h3 class="h4 mb-2">Ready to help?</h3>
    <p class="mb-4 text-white-50">
      Accept this problem and submit your solution to earn {{ problem.credits }}
      credits.
    </p>
    {% if is_problem_solved %}
    <div class="alert alert-success bg-opacity-25 border-0 text-white-75">
      This problem has already been solved.
    </div>
    <span class="badge-soft teal text-uppercase"
      >{{ problem.status_label }}</span
    >
    {% elif is_owner %}
    <div class="alert alert-info bg-opacity-25 border-0 text-white-75">
      You posted this problem, so it is waiting for peers to solve.
    </div>
    {% elif is_current_solver %}
    <div class="d-flex flex-wrap justify-content-center gap-3">
      <a
        class="btn btn-orange d-inline-flex align-items-center gap-2"
        href="{% url 'submit-solution' problem.slug %}"
      >
        Continue to Submit Solution
        <i data-lucide="arrow-right"></i>
      </a>
      <form method="post" action="{% url 'problem-release' problem.slug %}">
        {% csrf_token %}
        <button
          class="btn btn-orange-outline d-inline-flex align-items-center gap-2"
          type="submit"
        >
          Release Problem
          <i data-lucide="unlock"></i>
        </button>
      </form>
    </div>
    <p class="small text-white-50 mt-3 mb-0">
      Releasing the problem makes it available to other solvers.
    </p>
    {% elif is_locked_by_other %}
    <div class="alert alert-warning bg-opacity-25 border-0 text-white-75">
      Another solver is currently working on this problem. Please check back
      later.
    </div>
    <button
      class="btn btn-orange-soft d-inline-flex align-items-center gap-2"
      type="button"
      disabled
    >
      Problem Locked
      <i data-lucide="shield"></i>
    </button>
    {% elif can_accept_problem %} {% if is_user_verified %}
    <form
      method="post"
      action="{% url 'problem-accept' problem.slug %}"
      class="d-inline-flex"
    >
      {% csrf_token %}
      <button
        class="btn btn-orange d-inline-flex align-items-center gap-2"
        type="submit"
      >
        Accept Problem & Submit Solution
        <i data-lucide="arrow-right"></i>
      </button>
    </form>
    {% else %}
    <a
      href="{% url 'verification' %}"
      class="btn btn-orange-outline d-inline-flex align-items-center gap-2"
    >
      <i data-lucide="shield-check"></i>
      Verify Your Account to Help
    </a>
    {% endif %}
    {% else %}
    <div class="alert alert-secondary bg-opacity-25 border-0 text-white-75">
      Accepting this problem is currently unavailable.
    </div>
    {% endif %}
  </div>
</section>

{% if solutions %}
<section class="solutions-list d-flex flex-column gap-4">
  <h2 class="h5 text-gray-900">Solutions ({{ solutions|length }})</h2>
  {% for solution in solutions %}
  <div class="mentora-card solution-card">
    <div class="card-body p-4">
      <div class="d-flex align-items-start gap-3 mb-3">
        {% include "components/avatar.html" with src=solution.author.avatar initials=solution.author.initials|default:solution.author.name|first extra_classes="solution-avatar" %}
        <div class="flex-grow-1">
          <div class="d-flex flex-wrap align-items-center gap-2 mb-1">
            <span class="fw-semibold text-gray-900"
              >{{ solution.author.name }}</span
            >
            {% if solution.accepted %}
            <span
              class="badge-soft teal d-inline-flex align-items-center gap-1"
            >
              <i data-lucide="check-circle"></i>
              Accepted Solution
            </span>
            {% endif %}
          </div>
          <div class="small text-muted-soft d-flex flex-wrap gap-3">
            <span class="d-inline-flex align-items-center gap-1">
              <i data-lucide="award" class="text-amber-600"></i>
              {{ solution.author.credits }}
            </span>
            <span>⭐ {{ solution.author.rating }}</span>
            <span>{{ solution.time }}</span>
          </div>
        </div>

        {% if solution.can_edit %}
        <div class="ms-auto d-flex flex-column flex-sm-row gap-2">
          <a
            class="btn btn-orange-outline btn-sm d-inline-flex align-items-center gap-1 justify-content-center"
            href="{{ solution.edit_url }}"
          >
            <i data-lucide="edit-3"></i>
            Update
          </a>
          <form
            method="post"
            action="{{ solution.delete_url }}"
            data-confirm="Delete this solution?"
          >
            {% csrf_token %}
            <button
              class="btn btn-orange btn-sm d-inline-flex align-items-center gap-1 justify-content-center"
              type="submit"
            >
              <i data-lucide="trash"></i>
              Delete
            </button>
          </form>
        </div>
        {% endif %}
      </div>
      <div class="solution-content text-muted-soft whitespace-pre-line">
        {{ solution.content }}
      </div>
    </div>
  </div>
  {% endfor %}
</section>
{% endif %}

<div
  class="modal fade"
  id="mentoraConfirmModal"
  tabindex="-1"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header border-0 pb-0">
        <h5 class="modal-title">Confirm Action</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body pt-2">
        <p class="mb-0 text-muted-soft" data-confirm-message>Are you sure?</p>
      </div>
      <div class="modal-footer border-0 pt-0">
        <button type="button" class="btn btn-light" data-bs-dismiss="modal">
          Cancel
        </button>
        <button type="button" class="btn btn-orange" data-confirm-accept>
          Yes, continue
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}
